"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.successMessage = successMessage;
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _glob = _interopRequireDefault(require("glob"));

var _ssg = require("@takeshape/ssg");

var _linkedCommand = _interopRequireDefault(require("../../util/linked-command"));

var _zip = require("./zip");

var _log = _interopRequireDefault(require("../../log"));

var _chalk = _interopRequireDefault(require("chalk"));

var _prettyBytes = _interopRequireDefault(require("pretty-bytes"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function countFiles(projectPath, config) {
  const staticFiles = _glob.default.sync(`${_path.default.join(projectPath, config.staticPath)}/**/*.*`);

  const templateFiles = _glob.default.sync(`${_path.default.join(projectPath, config.templatePath)}/**/*.*`);

  return staticFiles.length + templateFiles.length;
}

function successMessage({
  siteName,
  zipSize,
  fileCount
}) {
  (0, _log.default)(_chalk.default.green('Site was successfully deployed!'));
  (0, _log.default)(`Deploy Target: ${_chalk.default.green(siteName)}`);
  (0, _log.default)(`Deploy Size: ${_chalk.default.green((0, _prettyBytes.default)(zipSize))}`);
  (0, _log.default)(`Files Deployed: ${_chalk.default.green(`${fileCount}`)}`);
}

var _default = (0, _linkedCommand.default)(async (command, params) => {
  if (!params.siteId || !params.siteName) {
    (0, _log.default)('Error: no site selected. Please run `tsg init`.');
    process.exit(1);
  }

  try {
    const projectPath = _path.default.dirname(params.configFilePath);

    const configFilename = _path.default.basename(params.configFilePath);

    const config = await (0, _ssg.loadConfig)((0, _ssg.createFileSystemLoader)(projectPath), configFilename);
    const zipSize = await (0, _zip.deployZip)({
      config,
      params,
      projectPath
    });
    successMessage({
      siteName: params.siteName,
      fileCount: countFiles(projectPath, config),
      zipSize
    });
  } catch (e) {
    (0, _log.default)('An error occurred with deploying - ', e);
    process.exit(1);
  }
});

exports.default = _default;