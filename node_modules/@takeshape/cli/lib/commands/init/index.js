"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = command;

var _log = _interopRequireDefault(require("../../log"));

var _saga = require("../../saga");

var _prompt = require("../../prompt");

var _messages = require("./messages");

var _login = require("./login");

var _config = require("./config");

var _auth = require("../../auth");

var _data = require("./data");

var _glitch = require("../../util/glitch");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function* command(name, params) {
  try {
    let authToken;

    if (params.cliLogin) {
      authToken = yield (0, _saga.call)(_login.loginCli, params, 3);
    } else {
      authToken = yield (0, _saga.call)(_login.loginBrowser, params);
    }

    const projects = yield (0, _saga.call)(_data.fetchProjects, params, authToken);

    if (!projects.length) {
      return yield (0, _saga.call)(_messages.noProjectsError, params);
    }

    const project = yield (0, _saga.call)(_prompt.promptList, 'Select a project:', projects);
    const projectToken = yield (0, _saga.call)(_auth.projectAuth, params.endpoint, project.value, authToken);
    const sites = yield (0, _saga.call)(_data.fetchSites, params, projectToken, project.value);
    let site;

    if (sites.length) {
      site = yield (0, _saga.call)(_prompt.promptList, 'Select a site:', sites);

      if (!site) {
        yield (0, _saga.call)(_messages.noSiteWarning);
      }
    } else {
      yield (0, _saga.call)(_messages.noSitesConfiguredWarning);
    }

    if (yield (0, _saga.call)(_glitch.isGlitch)) {
      if (yield (0, _saga.call)(_prompt.confirm, _messages.glitchConfirm)) {
        yield (0, _saga.call)(_glitch.updateEnv, projectToken, project, site);
        return;
      }
    }

    yield (0, _saga.call)(_config.writeConfigs, params, projectToken, project, site);
  } catch (e) {
    yield (0, _saga.call)(_log.default, e);
  }
}