"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.buildHandler = buildHandler;
exports.default = void 0;

var _ssg = require("@takeshape/ssg");

var _files = require("../files");

var _pusher = require("../util/pusher");

var _linkedCommand = _interopRequireDefault(require("../util/linked-command"));

var _connector = require("../util/connector");

var _runner = require("../util/runner");

var _watcher = require("../util/watcher");

var _path = _interopRequireDefault(require("path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function buildHandler(config, params) {
  const {
    connector
  } = params;
  return async clearCache => {
    if (clearCache && connector.clearCache) {
      await connector.clearCache();
    }

    const pages = await (0, _ssg.generate)(config, params);
    return (0, _files.writePages)(config.buildPath)(pages);
  };
}

var _default = (0, _linkedCommand.default)(async (command, params) => {
  const sitePath = _path.default.dirname(params.configFilePath);

  const fileLoader = (0, _ssg.createFileSystemLoader)(sitePath);
  const templateFileLoader = (0, _ssg.createSyncFileSystemLoader)(sitePath);
  const config = await (0, _ssg.loadConfig)(fileLoader, _path.default.basename(params.configFilePath), {
    env: process.env
  });
  const connector = (0, _connector.createConnector)(params, {
    cache: params.cache
  });
  const build = (0, _runner.createRunner)('tsg build', buildHandler(config, {
    connector,
    fileLoader,
    templateFileLoader
  }));
  await Promise.all([build(false), (0, _files.copyStatic)(config)]);

  if (command === 'watch') {
    (0, _watcher.createWatcher)('templates', build.bind(null, false), config.templatePath);
    (0, _watcher.createWatcher)('static', (0, _files.syncStatic)(config), config.staticPath);

    if (params.watchContent) {
      await (0, _pusher.subscribe)(params, build.bind(null, true));
    }
  }
});

exports.default = _default;